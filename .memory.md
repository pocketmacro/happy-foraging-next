# Happy Foraging - Project Memory

## Project Overview
A Next.js 14 web application for foraging enthusiasts, featuring recipes and guides using wild ingredients. Built with TypeScript, Supabase backend, and Tailwind CSS.

## Tech Stack
- **Framework**: Next.js 14 with App Router
- **Language**: TypeScript
- **Database**: Supabase (PostgreSQL)
- **Storage**: Supabase Storage (for images)
- **Auth**: Supabase Auth with @supabase/ssr (cookie-based sessions)
- **Styling**: Tailwind CSS
- **Markdown**: @uiw/react-md-editor for WYSIWYG editing

## Project Structure

### Key Directories
```
app/
  ├── page.tsx                    # Public homepage (shows featured recipes)
  ├── recipes/
  │   ├── page.tsx               # Public recipes listing
  │   └── [slug]/page.tsx        # Individual recipe detail page
  ├── guides/
  │   ├── page.tsx               # Public guides listing
  │   └── [slug]/page.tsx        # Individual guide detail page
  ├── admin/
  │   ├── page.tsx               # Admin dashboard with stats
  │   ├── login/page.tsx         # Admin login page
  │   ├── recipes/page.tsx       # Recipe management (CRUD)
  │   ├── guides/page.tsx        # Guide management (CRUD)
  │   └── ingredients/page.tsx   # Ingredient management (CRUD)
components/
  ├── admin/
  │   ├── AdminNav.tsx           # Admin navigation bar
  │   ├── CategoryInput.tsx      # Tag-based category input with autocomplete
  │   ├── ImageUpload.tsx        # Supabase image upload component
  │   ├── IngredientSearch.tsx   # Autocomplete ingredient search
  │   ├── MarkdownEditor.tsx     # WYSIWYG markdown editor with image upload
  │   ├── MediaBrowser.tsx       # Browse/select uploaded images
  │   └── RecipeImagesSection.tsx # Reusable recipe images section
  ├── RecipeCard.tsx             # Recipe card component
  └── MarkdownPreview.tsx        # Renders markdown content
lib/
  ├── supabase.ts                # All Supabase functions and types
  ├── utils.ts                   # Utility functions (slug generation, etc.)
  └── recipeImporter.ts          # Recipe text parser for Quick Import
supabase/
  └── migrations/                # Database migration files
```

## Database Schema

### Core Tables

**recipes**
- `id` (BIGSERIAL, PRIMARY KEY)
- `title` (TEXT)
- `slug` (TEXT, UNIQUE) - SEO-friendly URL slug
- `description` (TEXT)
- `category` (TEXT[]) - Array of category strings
- `prep_time` (INTEGER) - Minutes
- `cook_time` (INTEGER) - Minutes
- `servings` (INTEGER)
- `difficulty` (TEXT) - 'easy', 'medium', 'hard'
- `icon` (TEXT) - Emoji
- `image` (TEXT) - Legacy image URL (deprecated, use recipe_images)
- `instructions` (TEXT) - Markdown formatted
- `published` (BOOLEAN)
- `featured` (BOOLEAN) - Show on homepage
- `created_at`, `updated_at`

**ingredients**
- `id` (BIGSERIAL, PRIMARY KEY)
- `name` (TEXT)
- `category` (TEXT) - 'vegetables', 'fruits', 'herbs', 'mushrooms', 'nuts', 'pantry', 'other'
- `url` (TEXT, nullable) - Purchase link
- `created_at`, `updated_at`

**recipe_ingredients** (junction table)
- `id` (BIGSERIAL, PRIMARY KEY)
- `recipe_id` (BIGINT, FOREIGN KEY → recipes)
- `ingredient_id` (BIGINT, FOREIGN KEY → ingredients)
- `quantity` (TEXT) - e.g., "2 cups", "3 cloves"
- `optional` (BOOLEAN)
- `notes` (TEXT) - e.g., "chopped", "diced"

**recipe_images**
- `id` (BIGSERIAL, PRIMARY KEY)
- `recipe_id` (BIGINT, FOREIGN KEY → recipes, ON DELETE CASCADE)
- `storage_path` (TEXT) - Path in Supabase Storage
- `public_url` (TEXT) - Public URL
- `is_primary` (BOOLEAN) - Primary image for recipe card/header
- `display_order` (INTEGER) - Order in gallery
- `alt_text` (TEXT)
- `created_at`

**guides**
- `id` (BIGSERIAL, PRIMARY KEY)
- `title` (TEXT)
- `slug` (TEXT, UNIQUE)
- `description` (TEXT)
- `content` (TEXT) - Markdown formatted
- `category` (TEXT)
- `icon` (TEXT)
- `image` (TEXT)
- `published` (BOOLEAN)
- `created_at`, `updated_at`

### Storage Buckets

**recipe-images**
- Stores recipe header images and gallery images
- Path structure: `recipes/{recipeId}/` or `recipes/content/` for markdown images
- RLS policies: Public read, authenticated insert/update/delete

## Authentication & Security

### Admin Authentication Flow
1. User navigates to `/admin/*` (except `/admin/login`)
2. `middleware.ts` checks for Supabase session
3. If no session, redirects to `/admin/login`
4. Login page uses `createClientComponentClient()` for sign-in
5. After successful auth, redirected to `/admin`

### Supabase Clients
- **Server Components**: Use `createClient()` from `@supabase/ssr` (for reading public data)
- **Client Components**: Use `createClientComponentClient()` (for authenticated operations)
- **CRUD Operations**: All admin mutations use `createClientComponentClient()`

### Row Level Security (RLS)
- Database tables have RLS enabled
- Storage buckets have policies:
  - Public read access
  - Authenticated users can insert/update/delete

## Key Features & Patterns

### Multi-Category System
- Recipes support multiple categories (TEXT[] array)
- `CategoryInput` component provides:
  - Tag-based interface with removable chips
  - Autocomplete with default suggestions
  - Enter or comma to add categories
  - Case-insensitive duplicate prevention
  - Backspace to remove last tag

### Image Management
- **Recipe Images**:
  - Upload to Supabase Storage bucket `recipe-images`
  - Primary image for recipe card/header
  - Additional images for gallery
  - Stored in `recipe_images` table with metadata
- **Content Images**:
  - Images uploaded from markdown editor
  - Stored in `recipes/content/` or `guides/content/`
  - `MediaBrowser` component to select existing images

### Recipe Import (Quick Import)
- `parseRecipeText()` function in `lib/recipeImporter.ts`
- Parses plain text with ingredients and instructions
- Modal workflow:
  1. User enters title, description (optional), and recipe text
  2. Parser extracts ingredients with quantities
  3. Automatically creates new ingredients if they don't exist
  4. Populates recipe form with parsed data
  5. Opens edit form for user to finalize details

### Recipe Creation Workflow
1. **New Recipe**: User fills form, images section shows tip to save first
2. **Save**: Recipe is created and form switches to edit mode
3. **Edit Mode**: Recipe Images section becomes active
4. **Upload Images**: User can upload images immediately
5. **Update**: Changes are saved

### Markdown Editor
- Three preview modes: Live Preview, Edit Only, Preview Only
- Built-in image upload to Supabase Storage
- Media browser to select existing uploaded images
- Height: 500px for instructions/content

### Slug Generation
- Automatic from title for SEO-friendly URLs
- Can be manually edited
- Used in `/recipes/[slug]` and `/guides/[slug]` routes
- Fallback to ID for backwards compatibility

## Component Patterns

### Reusable Admin Components

**CategoryInput**
```tsx
<CategoryInput
  categories={formData.category}
  onChange={(categories) => setFormData({ ...formData, category: categories })}
/>
```

**IngredientSearch**
```tsx
<IngredientSearch
  onSelect={(ingredient) => setCurrentIngredient({ ...currentIngredient, ingredient })}
  placeholder="Search or create ingredient..."
/>
```

**MarkdownEditor**
```tsx
<MarkdownEditor
  label="Instructions"
  value={formData.instructions}
  onChange={(value) => setFormData({ ...formData, instructions: value })}
  contentType="recipes"
  required
/>
```

**RecipeImagesSection**
```tsx
<RecipeImagesSection
  recipeId={editingRecipe?.id || null}
  images={recipeImages}
  onImagesChange={() => editingRecipe && loadRecipeImages(editingRecipe.id)}
/>
```

## Important Coding Patterns

### Form State Management
```typescript
const [formData, setFormData] = useState<RecipeFormData>({
  title: '',
  slug: '',
  category: [],
  // ... other fields
})

// Update fields
setFormData({ ...formData, title: e.target.value })
```

### Ingredient Alignment Fix
- All input columns have fixed-height spacers (`h-6 mt-1`)
- Prevents layout shift when "Selected: X" text appears
- Grid uses normal layout (not `items-end`)

### Supabase Operations Pattern
```typescript
// Create
const created = await createRecipe(formData)
if (!created) {
  alert('Error creating recipe')
  return
}

// Update
const updated = await updateRecipe(id, formData)

// Delete with confirmation
if (!confirm('Are you sure?')) return
const success = await deleteRecipe(id)
```

## Styling Conventions

### Tailwind Utility Classes
- `btn-primary`: Primary action buttons
- `btn-secondary`: Secondary action buttons
- `card`: Card container with shadow
- `container-custom`: Max-width container
- `heading-2`, `heading-3`: Typography classes
- `text-text-dark`: Primary text color
- `text-text-medium`: Secondary text color
- `bg-primary`, `bg-primary-dark`: Brand colors
- `bg-bg-light`, `bg-bg-light-green`: Background colors

### Custom Colors (tailwind.config.ts)
```
primary: '#4A7C59' (forest green)
primary-dark: '#2F5940'
secondary: '#F4A460' (sandy brown)
accent-orange: '#FF6B35'
text-dark: '#1A1A1A'
text-medium: '#666666'
bg-light: '#F8F9FA'
bg-light-green: '#F0F7F4'
```

## Migration Strategy

### Creating Migrations
```bash
# Get timestamp
date +"%Y%m%d%H%M%S"

# Create migration file
# supabase/migrations/TIMESTAMP_description.sql

# Apply migration
npm run db:push
# or with confirmation
echo "Y" | npx supabase db push --include-all
```

### Migration Examples
- `20241128000000_initial_schema.sql` - Initial tables
- `20251128175837_add_recipe_images.sql` - Recipe images table + storage
- `20251128204755_add_featured_to_recipes.sql` - Featured flag
- `20251128210700_change_recipe_category_to_array.sql` - Multi-category
- `20251128171440_add_url_to_ingredients.sql` - Purchase URLs

## Common Issues & Solutions

### Issue: Image Upload "violates RLS policy"
**Solution**: Ensure storage policies exist for authenticated users:
```sql
CREATE POLICY "Authenticated users can upload"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'recipe-images' AND auth.role() = 'authenticated');
```

### Issue: CRUD operations return 406/403
**Solution**: Use `createClientComponentClient()` instead of server client for mutations

### Issue: Next.js image hostname not configured
**Solution**: Add Supabase hostname to `next.config.js`:
```js
images: {
  domains: ['jfybqfqxethprtvnkuvj.supabase.co']
}
```

### Issue: Ingredient display showing JSON
**Solution**: Ensure `createIngredient()` is called with correct parameters:
```typescript
// Correct
createIngredient(name, category, url)
// Incorrect
createIngredient({ name, category, url })
```

### Issue: Layout shift when selecting ingredient
**Solution**: Add fixed-height containers (`h-6 mt-1`) to all columns

## Environment Variables

Required in `.env.local`:
```
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

## Development Commands

```bash
npm run dev          # Start development server
npm run build        # Build for production
npm run db:push      # Apply migrations to Supabase
npx supabase db push --include-all  # Apply all migrations
```

## Feature Checklist

### Implemented
- ✅ Admin authentication with Supabase Auth
- ✅ Recipe CRUD with ingredients
- ✅ Multi-category system with autocomplete
- ✅ Image upload to Supabase Storage
- ✅ Recipe images with primary/gallery support
- ✅ WYSIWYG markdown editor with image upload
- ✅ Media browser for existing images
- ✅ Quick Recipe Import from text
- ✅ Featured recipes on homepage
- ✅ Slug-based URLs for SEO
- ✅ Ingredient management with purchase URLs
- ✅ Guide CRUD
- ✅ Admin dashboard with real-time stats

### Not Yet Implemented
- ⬜ User comments/ratings
- ⬜ Recipe search/filtering on public pages
- ⬜ Print recipe view
- ⬜ Recipe sharing (social media)
- ⬜ Seasonal ingredient calendar
- ⬜ Foraging location guides

## Design Decisions

1. **Multi-category over single**: Recipes often fit multiple categories (e.g., "Breakfast" + "Salads")
2. **Slug-based URLs**: Better for SEO than ID-based URLs
3. **Featured flag**: Allows curating homepage content without complex logic
4. **Storage over database for images**: Supabase Storage is optimized for files
5. **Markdown for content**: Flexible, future-proof, familiar to developers
6. **Import feature**: Reduces friction for adding recipes from external sources
7. **Reusable components**: Consistency between New/Edit forms

## Future Considerations

- Consider adding full-text search (Supabase supports it)
- May want to add recipe versions/history
- Could add user-submitted recipes (moderate before publish)
- Consider adding nutrition information
- May want to add print styles for recipes
- Consider adding recipe collections/meal plans
